
com=window.com||{};com.marklogic=window.com.marklogic||{};com.marklogic.widgets=window.com.marklogic.widgets||{};com.marklogic.widgets.searchhelper={};com.marklogic.widgets.searchhelper.processValueAll=function(str){return com.marklogic.widgets.searchhelper.processValue(str,"all");};com.marklogic.widgets.searchhelper.processValue=function(str,mode){var name=str;name=com.marklogic.widgets.searchhelper.splitdash(name,mode);name=com.marklogic.widgets.searchhelper.splitunderscore(name,mode);name=com.marklogic.widgets.searchhelper.camelcase(name,mode);return name;};com.marklogic.widgets.searchhelper.snippet=function(result){var resStr="";for(var i=0;i<result.matches.length;i++){resStr+="<div class='searchresults-snippet'>\"";for(var m=0;m<result.matches[i]["match-text"].length;m++){if("string"==typeof result.matches[i]["match-text"][m]){resStr+=result.matches[i]["match-text"][m];}else{resStr+="<span class='searchresults-snippet-highlight'>"+result.matches[i]["match-text"][m].highlight+"</span>";}}
resStr+="\"</div>";}
return resStr;};com.marklogic.widgets.searchhelper.splitdash=function(value,mode){if(value==undefined||value==null){mljs.defaultconnection.logger.warn("WARNING: splitdash(): value is "+value);return"";}
if("string"!=typeof value){mljs.defaultconnection.logger.warn("WARNING: splitdash(): value is not of type string, but of type '"+(typeof value)+"'");return""+value;}
var name=value;if("all"==mode||"splitdash"==mode){var parts=name.split("-");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i]+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.splitunderscore=function(value,mode){var name=value;if("all"==mode||"splitunderscore"==mode){var parts=name.split("_");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i]+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.camelcase=function(value,mode){var name=value;if("all"==mode||"camelcase"==mode){var parts=name.split(" ");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i].substring(0,1).toUpperCase()+parts[i].substring(1)+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.jsontohtml=function(json){var str="<div class='jsonhtml'>";for(var tag in json){if("object"==typeof json[tag]){str+="<div class='jsonproperty'><div class='jsonpropertytitlewrapper'><span class='jsonpropertytitle'>"+com.marklogic.widgets.searchhelper.camelcase(tag)+":- </span></div>";str+=com.marklogic.widgets.searchhelper.jsontohtml(json[tag]);str+="</div>";}else{str+="<div class='jsonproperty'><div class='jsonpropertytitlewrapper'>";str+="<span class='jsonpropertytitle'>"+com.marklogic.widgets.searchhelper.camelcase(tag)+": </span>";str+="<span class='jsonpropertyvalue'>"+json[tag]+"</span>";str+="</div></div>";}}
str+="</div>";return str;};com.marklogic.widgets.searchhelper.xmltohtml=function(xml){};com.marklogic.widgets.searchbar=function(container){if(undefined==com.marklogic.widgets.searchbar.list){com.marklogic.widgets.searchbar.list=new Array();}
this.container=container;this.ctx=new mljs.prototype.searchcontext();this._mode="fullquery";mljs.defaultconnection.logger.debug("adding search bar html");document.getElementById(container).innerHTML="<div class='searchbar-inner'>"+"<div class='searchbar-queryrow'>"+"<label class='searchbar-label' for='"+container+"-searchinput'>Search: </label>"+"<input class='searchbar-query' type='text' id='"+container+"-searchinput' value='' />"+"<input class='btn btn-primary searchbar-submit' type='submit' id='"+container+"-submit' value='Search' />"+"</div><div class='searchbar-errorrow hidden'></div>";"</div>";mljs.defaultconnection.logger.debug("adding submit click handler");var self=this;document.getElementById(container+"-submit").onclick=function(){self._dosearch(self);};mljs.defaultconnection.logger.debug("added submit click handler");var searchKeyPress=function(e)
{if(typeof e=='undefined'&&window.event){e=window.event;}
if(e.keyCode==13)
{document.getElementById(container+"-submit").click();}};document.getElementById(container+"-searchinput").onkeypress=searchKeyPress;};com.marklogic.widgets.searchbar.__dosearch=function(submitelement){var id=submitelement.getAttribute("id");id=id.substring(0,id.length-12);var bar=com.marklogic.widgets.searchbar.list[id];if(null==id){mljs.defaultconnection.logger.debug("searchbar.__dosearch - search bar instance does not exist: "+id);}else{bar._dosearch();}};com.marklogic.widgets.searchbar.prototype.clear=function(){document.getElementById(this.container+"-searchinput").value="";this.ctx.reset();};com.marklogic.widgets.searchbar.prototype.execute=function(){var q=document.getElementById(this.container+"-searchinput").value;this.ctx.dosimplequery(q);};com.marklogic.widgets.searchbar.prototype.setMode=function(mode){this._mode=mode;};com.marklogic.widgets.searchbar.prototype.setModeContributeStructured=function(){this._mode="contributestructured";};com.marklogic.widgets.searchbar.prototype._dosearch=function(self){var q=document.getElementById(self.container+"-searchinput").value;if(this._mode=="fullquery"){self.ctx.dosimplequery(q);}else if(this._mode=="contributestructured"){var qb=new this.ctx.db.query();qb.query(qb.term(q));self.ctx.contributeStructuredQuery(this.container,qb.toJson().query);}};com.marklogic.widgets.searchbar.prototype.updateSimpleQuery=function(q){if(null!=q&&undefined!=q&&""!=q){mljs.defaultconnection.logger.debug(" - updateSimpleQuery: Setting query string to: "+q);document.getElementById(this.container+"-searchinput").value=q;}};com.marklogic.widgets.searchbar.prototype.updateResults=function(results){if(typeof(results)!="boolean"&&undefined!=results&&null!=results&&undefined!=results.qtext){mljs.defaultconnection.logger.debug(" - updateResults: Setting query string to: "+results.qtext);document.getElementById(this.container+"-searchinput").value=results.qtext;}};com.marklogic.widgets.searchbar.prototype.setContext=function(context){this.ctx=context;};com.marklogic.widgets.searchbar.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchfacets=function(container){this.container=container;this.listSize=5;this.extendedSize=10;this.allowShowAll=true;this.hideEmptyFacets=true;this.facetSettings=new Array();this.results=null;this.ctx=mljs.defaultconnection.createSearchContext();this.selected=new Array();this.facetNameTransform="all";this.facetValueTransform="all";this.selectionPublisher=new com.marklogic.events.Publisher();this._refresh();};com.marklogic.widgets.searchfacets.getConfigurationDefinition=function(){return{listSize:{type:"positiveInteger",minimum:1,default:5,title:"List Size",description:"How many facet values to show at first."},extendedSize:{type:"positiveInteger",minimum:1,default:10,title:"Extended List Size",description:"How many values to show when a user clicks 'Show More'."},allowShowAll:{type:"boolean",default:true,title:"Display Show All action",description:"Whether the Show All link should be allowed if there are more facet values than the value of Extended Size."},hideEmptyFacets:{type:"boolean",default:true,title:"Hide Empty Facets",description:"Should facets with no values be hidden?"}}};com.marklogic.widgets.searchfacets.prototype.setConfiguration=function(config){for(var prop in config){this[prop]=config[prop];}
this._refresh();};com.marklogic.widgets.searchfacets.prototype.setContext=function(context){this.ctx=context;};com.marklogic.widgets.searchfacets.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchfacets.prototype._setFacetSettings=function(facetName,extended,showall){var json={extended:extended,showAll:showall};this.facetSettings[facetName]=json;};com.marklogic.widgets.searchfacets.prototype._getFacetSettings=function(facetName){var res=this.facetSettings[facetName];if(undefined==res||null==res){return{extended:false,showAll:false};}else{return res;}};com.marklogic.widgets.searchfacets.prototype.clear=function(){this.results=null;this._refresh();};com.marklogic.widgets.searchfacets.prototype._refresh=function(){if(false==this.results||true==this.results){return;}
var more=new Array();var extended=new Array();var str="<div class='mljswidget searchfacets'><div class='title searchfacets-title'>Browse</div> <div id='"+this.container+"-facetinfo' class='search-facets'> ";var self=this;var fname=function(name){var opts=self.ctx.getOptions();var annotation=opts._findConstraint(name).annotation;if(undefined==annotation){return self._transformFacetName(name);}else{return annotation[0];}};var deselectionTodo=new Array();if(0!=this.selected.length){str+="<div class='searchfacets-selected'>";for(var i=0;i<this.selected.length;i++){var s=this.selected[i];str+="<div class='searchfacets-selection'>"+"<a href='#"+this.container+"-desel-"+s.name+"-"+s.value+"' class='searchfacets-deselect' id='"+this.container+"-desel-"+s.name+"-"+s.value+"'>X</a> "+
fname(s.name)+": "+this._transformFacetValue(s.name,s.value)+"</div>";deselectionTodo.push(s);}
str+="</div>";}
var facetHandlersTodo=new Array();if(null!=this.results&&undefined!=this.results){if(undefined!=this.results.facets){for(var name in this.results.facets){var facet=this.results.facets[name];var facetStr="<div class='searchfacets-facet' id='"+this.container+"-facetinfo-"+name+"'><div class='searchfacets-facet-title'>"+fname(name)+"</div>"+"<div class='searchfacets-facet-values'>";var settings=this._getFacetSettings(name);var max=this.listSize;var values=facet.facetValues;bubbleSort(values,"count");var valuesCount=values.length;if(settings.extended){max=this.extendedSize;}
if(settings.showAll&&settings.extended){max=valuesCount;}
for(var v=0;v<max&&v<valuesCount;v++){if(v<this.listSize||(v<this.extendedSize&&settings.extended)||settings.showAll){var fv=values[v];facetStr+="<div class='searchfacets-facet-value' id='"+this.container+"-fv-"+name+"-"+fv.name+"'>"+this._transformFacetValue(name,fv.name)+" ("+fv.count+")"+"</div>";facetHandlersTodo.push({name:name,value:fv.name});}}
if(valuesCount>this.listSize){if(!settings.showAll){facetStr+="<div class='searchfacets-more'><a href='#"+this.container+"-facetinfo-"+name+"' id='"+this.container+"-"+name+"-more-link'>";if(!settings.extended){facetStr+="More";}else{facetStr+="Less";}
facetStr+="...</a></div>";more.push(name);}
if(settings.extended){if(valuesCount>this.extendedSize&&this.allowShowAll){facetStr+="<div class='searchfacets-extended'><a href='#"+this.container+"-facetinfo-"+name+"' id='"+this.container+"-"+name+"-extended-link'>";if(settings.showAll){facetStr+="Less"}else{facetStr+="All";}
facetStr+="...</a></div>";extended.push(name);}}}
facetStr+="</div></div>";if(!(0==valuesCount&&this.hideEmptyFacets)){str+=facetStr;}}}}
str+="</div></div>";document.getElementById(this.container).innerHTML=str;var self=this;var addfh=function(fh){var el=document.getElementById(self.container+"-fv-"+fh.name+"-"+fh.value);if(undefined!=el){el.onclick=function(){self._selectFacet(fh.name,fh.value)};}};for(var i=0;i<facetHandlersTodo.length;i++){var fh=facetHandlersTodo[i];addfh(fh);}
var remfh=function(fh){var el=document.getElementById(self.container+"-desel-"+fh.name+"-"+fh.value);if(undefined!=el){el.onclick=function(){self._deselectFacet(fh.name,fh.value)};}};for(var i=0;i<deselectionTodo.length;i++){var fh=deselectionTodo[i];remfh(fh);}
var addmoreh=function(morei){document.getElementById(self.container+"-"+morei+"-more-link").onclick=function(){self._more(morei);};};for(var i=0;i<more.length;i++){var morei=more[i];mljs.defaultconnection.logger.debug("more[i]: "+morei+" , i: "+i);addmoreh(morei);}
var addexth=function(exti){document.getElementById(self.container+"-"+exti+"-extended-link").onclick=function(){self._extended(exti);};};for(var i=0;i<extended.length;i++){var exti=extended[i];mljs.defaultconnection.logger.debug("extended[i]: "+exti+" , i: "+i);addexth(exti);}};com.marklogic.widgets.searchfacets.prototype._selectFacet=function(facetName,value){mljs.defaultconnection.logger.debug("Selecting "+facetName+":"+value);this.selected.push({name:facetName,value:value});this._refresh();this.selectionPublisher.publish(this.selected);};com.marklogic.widgets.searchfacets.prototype._deselectFacet=function(facetName,value){mljs.defaultconnection.logger.debug("Deselecting "+facetName+":"+value);var newsel=new Array();for(var i=0;i<this.selected.length;i++){var el=this.selected[i];if(el.name==facetName&&el.value==value){}else{newsel.push(el);}}
this.selected=newsel;this._refresh();this.selectionPublisher.publish(this.selected);};com.marklogic.widgets.searchfacets.prototype._transformFacetName=function(facetName){return com.marklogic.widgets.searchhelper.processValue(facetName,this.facetNameTransform);};com.marklogic.widgets.searchfacets.prototype._transformFacetValue=function(facetName,facetValue){var fv=this.ctx.getOptionsBuilder().getFacetValueString(facetName,facetValue);if(null==fv){return com.marklogic.widgets.searchhelper.processValue(facetValue,this.facetValueTransform);}else{return fv;}};com.marklogic.widgets.searchfacets.prototype._more=function(facetName){mljs.defaultconnection.logger.debug("searchfacets._more: "+facetName+", extended currently: "+this._getFacetSettings(facetName).extended);this._setFacetSettings(facetName,!this._getFacetSettings(facetName).extended,false);this._refresh();};com.marklogic.widgets.searchfacets.prototype._extended=function(facetName){mljs.defaultconnection.logger.debug("searchfacets._extended: "+facetName+", showAll currently: "+this._getFacetSettings(facetName).showAll);this._setFacetSettings(facetName,true,!this._getFacetSettings(facetName).showAll);this._refresh();};com.marklogic.widgets.searchfacets.prototype.setSizes=function(listSize,extendedSize){this.listSize=listSize;this.extendedSize=extendedSize;};com.marklogic.widgets.searchfacets.prototype.setAllowShowAll=function(boolvalue){this.allowShowAll=boolvalue;};com.marklogic.widgets.searchfacets.prototype.addFacetSelectionListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchfacets.prototype.removeFacetSelectionListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchfacets.prototype.updateFacets=function(results){if("boolean"==typeof results){return;}
this.results=results;this.selected=this.ctx.lastParsed.facets;this._refresh();};com.marklogic.widgets.searchfacets.prototype.updateSelectedFacets=function(facets){mljs.defaultconnection.logger.debug("In updateSelectedFacets(facets): "+JSON.stringify(facets));this.selected=facets;this._refresh();};com.marklogic.widgets.searchresults=function(container){this.container=container;this.ctx=mljs.defaultconnection.createSearchContext();this.selectionMode="append";this.processors={};this.availableProcessors=new Array();this.processorPriority=new Array();this.detailsLink=null;this.lazyId=1;this.lazyLoaders=new Array();var self=this;var htmlRec=function(content){var resStr="";console.log("type of content: "+(typeof content));if("string"==typeof content){return content;}else{for(var tag in content){console.log("processing tag: "+tag);resStr+="<"+tag;if(undefined!=content[tag].class){resStr+=" class='"+content[tag].class+"'";content[tag].class=undefined;}
if(undefined!=content[tag].id){resStr+=" id='"+content[tag].id+"'";content[tag].id=undefined;}
resStr+=">";console.log("calling htmlRec for tag: "+tag);resStr+=htmlRec(content[tag]);resStr+="</"+tag+">";}
return resStr;}};var handleJson=function(result,json){var resStr="";var title=result.uri;if(undefined!=json&&undefined!=json.title){title=json.title;}
var snippet=null;if(undefined!=json&&undefined!=json.summary){snippet=json.summary;}else if(undefined!=json){snippet=com.marklogic.widgets.searchhelper.jsontohtml(json);}else{}
if(null==snippet){self.ctx.db.logger.debug("defaultProcessor: No JSON summary, building JSON tree HTML output");}
resStr+="<div class='searchresults-result'><h3>"+result.index+". "+title+"</h3>";if(null!=snippet){resStr+="<div class='searchresults-snippet'>"+snippet+"</div>";}
resStr+="</div>";return resStr;};this.defaultProcessor={matcher:function(result){return true;},processor:function(result){self.ctx.db.logger.debug("matches: "+result.matches);if(undefined!=result.matches){self.ctx.db.logger.debug("first match: "+result.matches[0]);self.ctx.db.logger.debug("match text: "+result.matches[0]["match-text"]);self.ctx.db.logger.debug("match text 0: "+result.matches[0]["match-text"][0]);}
if("string"==typeof result.content&&result.content.substring(0,1)=="{"){self.ctx.db.logger.debug("Found JSON string object");var json=JSON.parse(result.content);self.ctx.db.logger.debug("defaultProcessor:  - JSON parse successful...");return handleJson(result,json);}else if("string"==typeof result.content&&-1!=result.content.substring(0,100).indexOf("<html")){self.ctx.db.logger.debug("searchresults: defaultProcesor: Got HTML content");var titleStart=result.content.indexOf("title>");var titleEnd=result.content.indexOf("title>",titleStart+6);var bodyStart=result.content.indexOf("body");var bodyEnd=result.content.indexOf(">",bodyStart+4);var endBodyStart=result.content.indexOf("body",bodyEnd+1);self.ctx.db.logger.debug("titleStart: "+titleStart);self.ctx.db.logger.debug("titleEnd: "+titleEnd);self.ctx.db.logger.debug("bodyStart: "+bodyStart);self.ctx.db.logger.debug("bodyEnd: "+bodyEnd);self.ctx.db.logger.debug("endBodyStart: "+endBodyStart);var bodyContent=result.content.substring(bodyEnd+1,endBodyStart);self.ctx.db.logger.debug("bodyContent: "+bodyContent);var title=result.uri;if(-1!=titleStart&&-1!=titleEnd){title=result.content.substring(titleStart+6,titleEnd);}else{var firstElStart=bodyContent.indexOf("<");var firstElEnd=bodyContent.indexOf(">",firstElStart+1);var endFirstElStart=bodyContent.indexOf("</",firstElEnd);if(-1!=firstElStart&&-1!=firstElEnd&&-1!=endFirstElStart){title=bodyContent.substring(firstElEnd+1,endFirstElStart);}}
self.ctx.db.logger.debug("title: "+title);var resStr="<div class='searchresults-result'><h3>"+result.index+". "+title+"</h3>";resStr+="<div class='searchresults-snippet'>"+bodyContent+"</div>";resStr+="</div>";return resStr;}
else if(undefined!=result.matches&&undefined!=result.matches[0]&&undefined!=result.matches[0]["match-text"]&&undefined!=result.matches[0]["match-text"][0]){self.ctx.db.logger.debug("defaultProcessor: Got a snippet match with a html element");var title=null;self.ctx.db.logger.debug("PATH: "+result.path);title=result.path.substring(8,result.path.length-2);var resStr="<div class='searchresults-result'><h3>"+result.index+". "+title+"</h3>";resStr+=com.marklogic.widgets.searchhelper.snippet(result);resStr+="</div>";return resStr;}else if("object"==typeof(result.content)){self.ctx.db.logger.debug("defaultProcessor: Got JSON Object content");return handleJson(result,result.content);}else{self.ctx.db.logger.debug("defaultProcessor: Got escaped string - Could be XML or JSON ...");try{var json=JSON.parse(result.content);self.ctx.db.logger.debug("defaultProcessor:  - JSON parse successful...");return handleJson(result,json);}catch(err){try{var xmlDoc=textToXML(result.content);self.ctx.db.logger.debug("defaultProcessor:  - XML parse successful...");var resStr="";var title=result.uri;var snippet=null;if(undefined!=xmlDoc.evaluate){var evalResult=xmlDoc.evaluate("//title[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //title[1]/text() undefined");evalResult=xmlDoc.evaluate("//name[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //name[1]/text() undefined");evalResult=xmlDoc.evaluate("//id[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //id[1]/text() undefined");evalResult=xmlDoc.evaluate("//h1[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //h1[1]/text() undefined");self.ctx.db.logger.debug("defaultProcessor: trying (//text())[1]");evalResult=xmlDoc.evaluate("(//text())[1]",xmlDoc,null,XPathResult.STRING_TYPE,null);self.ctx.db.logger.debug("defaultProcessor: output: "+evalResult.stringValue);}}}}
if(undefined!=evalResult&&null!=evalResult&&""!=evalResult.stringValue){title=evalResult.stringValue;}
evalResult=xmlDoc.evaluate("//summary[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //summary[1]/text() undefined");evalResult=xmlDoc.evaluate("//synopsis[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //synopsis[1]/text() undefined");evalResult=xmlDoc.evaluate("//description[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //description[1]/text() undefined");evalResult=xmlDoc.evaluate("//details[1]/text()",xmlDoc,null,XPathResult.STRING_TYPE,null);if(undefined==evalResult||""==evalResult.stringValue){self.ctx.db.logger.debug("defaultProcessor: //details[1]/text() undefined");self.ctx.db.logger.debug("defaultProcessor: trying (//text())[2]");evalResult=xmlDoc.evaluate("(//text())[2]",xmlDoc,null,XPathResult.STRING_TYPE,null);self.ctx.db.logger.debug("defaultProcessor: output: "+evalResult.stringValue);}}}}
if(undefined!=evalResult&&null!=evalResult&&""!=evalResult.stringValue){snippet=evalResult.stringValue;}}
if(null==snippet){self.ctx.db.logger.debug("defaultProcessor: No XML summary, building XML tree HTML output");snippet=com.marklogic.widgets.searchhelper.xmltohtml(xmlDoc);}
if(null==snippet){snippet=result.content;}
resStr+="<div class='searchresults-result'><h3>"+result.index+". "+title+"</h3>";if(null!=snippet){resStr+="<div class='searchresults-snippet'>"+snippet+"</div>";}
resStr+="</div>";return resStr;}catch(err){self.ctx.db.logger.debug("defaultProcessor: XML mode: Failed to create XML document from text: "+result.content);}}}}};this.builtinProcessors=[];this.builtinProcessors["svg"]={matcher:function(result){var xml=null;if("string"==typeof result.content){xml=textToXML(result.content);}else if("object"==typeof result.content&&undefined!=result.content.nodeType){xml=result.content;}
if(null!=xml){if(xml.childNodes[0].nodeName=="svg"){mljs.defaultconnection.logger.debug("Potential SVG nodeName: "+xml.childNodes[0].nodeName);mljs.defaultconnection.logger.debug("Potential SVG nodeType: "+xml.childNodes[0].nodeType);return true;}else{return false;}}
return false;},processor:function(result){return"<div class='searchresults-result'><h3>"+result.index+". "+result.uri+"</h3>"+"<div style='height: 200px;position:relative;'>"+result.content+"</div></div>";}};this._refresh();this.selectionPublisher=new com.marklogic.events.Publisher();this.highlightPublisher=new com.marklogic.events.Publisher();};com.marklogic.widgets.searchresults.getConfigurationDefinition=function(){return{selectionMode:{type:"enum",default:"append",title:"Selection Mode",description:"If no action happens on click, which selection mode to use.",options:[{value:"append",title:"Append",decsription:"Append this document to the list of those selection"},{value:"replace",title:"Replace",decsription:"Replace selection with the selected document only"}]}}};com.marklogic.widgets.searchresults.prototype.setConfiguration=function(config){for(var p in config){this[p]=config[p];}};com.marklogic.widgets.searchresults.prototype.setContext=function(context){this.ctx=context;};com.marklogic.widgets.searchresults.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchresults.prototype.details=function(urlspec){this.detailsLink=urlspec;};com.marklogic.widgets.searchresults.prototype.clear=function(){this.results=null;this._refresh();};com.marklogic.widgets.searchresults.prototype.updateResults=function(results){this.results=results;this._refresh();};com.marklogic.widgets.searchresults.prototype._refresh=function(){if(typeof this.results=="boolean"){if(true==this.results){document.getElementById(this.container).innerHTML="<div class='mljswidget searchresults-inner'>"+"<h2 class='title searchresults-title'>Results</h2><div class='searchresults-results'>"+
com.marklogic.widgets.bits.loading(this.container+"-loading")+"</div></div>";}else{document.getElementById(this.container).innerHTML="<div class='mljswidget searchresults-inner'>"+"<h2 class='title searchresults-title'>Results</h2><div class='searchresults-results'>"+
com.marklogic.widgets.bits.failure(this.container+"-failure")+"</div></div>";}
return;}
this.lazyLoaders=new Array();if(null==this.results||undefined==this.results.results||this.results.results.length==0){document.getElementById(this.container).innerHTML="<div class='mljswidget searchresults-inner'>"+"<h2 class='title searchresults-title'>Results</h2><div class='searchresults-results'>No Results</div>"+"</div>";}else{mljs.defaultconnection.logger.debug("RESULTS OBJECT: "+JSON.stringify(this.results));var resStr="<div class='mljswidget searchresults-inner'><h2 class='title searchresults-title'>Results</h2><div class='searchresults-results'>";var uureplace=1001;var replacements=new Array();var pointer=null!=this.detailsLink;for(var i=0;i<this.results.results.length;i++){var wrapperId=this.container+"-searchresults-wrapper-"+i;resStr+="<div id='"+wrapperId+"' class='searchresults-wrapper"
if(pointer){resStr+=" searchresults-navigable";}
resStr+="'>";var result=this.results.results[i];var found=false;for(var p=0;!found&&p<this.processorPriority.length;p++){var pname=this.processorPriority[p];mljs.defaultconnection.logger.debug("checking applicability of processor: "+pname);if(this.processors[pname].matcher(result)){found=true;mljs.defaultconnection.logger.debug("found processor: "+pname);var returned=this.processors[pname].processor(result,this);if(undefined!=returned.nodeType){var id=(uureplace++);resStr="<div id='"+this.container+"-searchresults-xml-"+id+"'></div>";replacements[id]=returned;}else{resStr+=returned;}}}
if(!found){mljs.defaultconnection.logger.debug("No processor found, checkin builtins");for(var pname in this.builtinProcessors){if('object'==typeof(this.builtinProcessors[pname])&&this.builtinProcessors[pname].matcher(result)){found=true;mljs.defaultconnection.logger.debug("found builtin processor: "+pname);var returned=this.builtinProcessors[pname].processor(result,this);if(undefined!=returned.nodeType){var id=(uureplace++);resStr="<div id='"+this.container+"-searchresults-xml-"+id+"'></div>";replacements[id]=returned;}else{resStr+=returned;}}}
if(!found){mljs.defaultconnection.logger.debug("No processor found, using default");resStr+=this.defaultProcessor.processor(result);}}
resStr+="</div>";}
resStr+="</div></div>";mljs.defaultconnection.logger.debug("RES STR: "+resStr);document.getElementById(this.container).innerHTML=resStr;var self=this;var addPointerHandler=function(id,result){document.getElementById(id).onclick=function(evt){self._navigateTo(result.uri);}};if(!pointer){addPointerHandler=function(id,result){document.getElementById(id).onclick=function(evt){self.selectionPublisher.publish({mode:self.selectionMode,uri:result.uri});}};}
for(var i=0;i<this.results.results.length;i++){var id=this.container+"-searchresults-wrapper-"+i;var result=this.results.results[i];addPointerHandler(id,result);}
for(var r=1001;r<uureplace;r++){document.getElementById(this.container+"-searchresults-xml-"+r).innerHTML=replacements[r];}
for(var i=0;i<this.lazyLoaders.length;i++){var loader=this.lazyLoaders[i];loader.callback(loader.docuri,loader.elid);}}};com.marklogic.widgets.searchresults.prototype.generateLazyID=function(){return this.lazyId++;};com.marklogic.widgets.searchresults.prototype.lazyLoad=function(docuri,elid,callback){this.lazyLoaders.push({docuri:docuri,elid:elid,callback:callback});};com.marklogic.widgets.searchresults.prototype._navigateTo=function(uri){var go=this.detailsLink.replace("#URI#",uri);window.location=go;};com.marklogic.widgets.searchresults.prototype.addResultHighlightListener=function(sl){this.highlightPublisher.subscribe(sl);};com.marklogic.widgets.searchresults.prototype.removeResultHighlightListener=function(sl){this.highlightPublisher.unsubscribe(sl);};com.marklogic.widgets.searchresults.prototype.addResultSelectionListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchresults.prototype.removeResultSelectionListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchresults.prototype.addProcessor=function(name,matcher_func,processor_func){this.processors[name]={matcher:matcher_func,processor:processor_func};this.availableProcessors.push(name);this.processorPriority.push(name);};com.marklogic.widgets.searchresults.prototype.removeProcessor=function(name){this.processors[name]=undefined;this.availableProcessors.remove(name);this.processorPriority.remove(name);};com.marklogic.widgets.searchresults.prototype.setProcessorPriority=function(procNameArray){this.processorPriority=procNameArray;};com.marklogic.widgets.searchresults.prototype.updateResultSelection=function(newsel){for(var i=0;i<this.results.results.length;i++){var wrapperId=this.container+"-searchresults-wrapper-"+i;var result=this.results.results[i];if(newsel.contains(result.uri)){com.marklogic.widgets.addClass(document.getElementById(wrapperId),"selected");}else{com.marklogic.widgets.removeClass(document.getElementById(wrapperId),"selected");}}};com.marklogic.widgets.searchresults.prototype.updateResultHighlight=function(newhigh){for(var i=0;i<this.results.results.length;i++){var wrapperId=this.container+"-searchresults-wrapper-"+i;var result=this.results.results[i];if(newhigh.contains(result.uri)){com.marklogic.widgets.addClass(document.getElementById(wrapperId),"highlighted");}else{com.marklogic.widgets.removeClass(document.getElementById(wrapperId),"highlighted");}}};com.marklogic.widgets.searchpager=function(container){this.container=container;this.perPage=10;this.start=0;this.total=0;this.ctx=mljs.defaultconnection.createSearchContext();this.pagePublisher=new com.marklogic.events.Publisher();document.getElementById(container).innerHTML="<div class='mljswidget searchpager'><span class='searchpager-showing' id='"+container+"-searchpager-showing'></span>"+"<span class='searchpager-first searchpager-button' id='"+container+"-searchpager-first'><a href='#' id='"+container+"-searchpager-first-a' class='searchpager-link'>&lt;&lt;  </a></span>"+"<span class='searchpager-previous searchpager-button' id='"+container+"-searchpager-previous'><a href='#' id='"+container+"-searchpager-previous-a' class='searchpager-link'>&lt;  </a></span>"+"<span class='searchpager-page' id='"+container+"-searchpager-page'>-</span>"+"<span class='searchpager-next searchpager-button' id='"+container+"-searchpager-next'><a href='#' id='"+container+"-searchpager-next-a' class='searchpager-link'>  &gt;</a></span>"+"<span class='searchpager-last searchpager-button' id='"+container+"-searchpager-last'><a href='#' id='"+container+"-searchpager-last-a' class='searchpager-link'>  &gt;&gt;</a></span></div>";var self=this;document.getElementById(container+"-searchpager-first-a").onclick=function(){self._first();};document.getElementById(container+"-searchpager-previous-a").onclick=function(){self._previous();};document.getElementById(container+"-searchpager-next-a").onclick=function(){self._next();};document.getElementById(container+"-searchpager-last-a").onclick=function(){self._last();};this._refresh();};com.marklogic.widgets.searchpager.prototype.setContext=function(context){this.ctx=context;};com.marklogic.widgets.searchpager.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchpager.prototype.clear=function(){this.updatePage(null);};com.marklogic.widgets.searchpager.prototype.updatePage=function(results){mljs.defaultconnection.logger.debug("updatePage: results: "+results);if("boolean"==typeof results){return;}
if(null==results){this.start=1;this.total=0;}else{this.perPage=results["page-length"];this.start=results.start;this.total=results.total;}
this._refresh();};com.marklogic.widgets.searchpager.prototype.addPageListener=function(l){this.pagePublisher.subscribe(l);};com.marklogic.widgets.searchpager.prototype.removePageListener=function(l){this.pagePublisher.unsubscribe(l);};com.marklogic.widgets.searchpager.prototype._refresh=function(){mljs.defaultconnection.logger.debug("REFRESH: start: "+this.start+", total: "+this.total+", perPage: "+this.perPage);var last=(this.start+this.perPage-1);if(last>this.total){last=this.total;}
var st=this.start;if(st>this.total){st=this.total;}
if(0==st){document.getElementById(this.container+"-searchpager-showing").innerHTML="Showing no results";}else{document.getElementById(this.container+"-searchpager-showing").innerHTML="Showing "+st+" to "+last+" of "+this.total;}
var page=Math.ceil(st/this.perPage);var maxpage=Math.ceil(this.total/this.perPage);if(0==st){page=0;maxpage=0;}
if(0==page){document.getElementById(this.container+"-searchpager-page").innerHTML=" - ";}else{document.getElementById(this.container+"-searchpager-page").innerHTML="Page "+page+" of "+maxpage;}
if(page<2){}else if(page==maxpage){}};com.marklogic.widgets.searchpager.prototype._fire=function(){this._refresh();var json={start:this.start,show:this.perPage};this.pagePublisher.publish(json);};com.marklogic.widgets.searchpager.prototype._first=function(){this.start=1;this._fire();};com.marklogic.widgets.searchpager.prototype._previous=function(){this.start=this.start-this.perPage;if(this.start<1){this.start=1;}
this._fire();};com.marklogic.widgets.searchpager.prototype._next=function(){this.start=this.start+this.perPage;var lastpage=1+Math.floor(this.total/this.perPage);mljs.defaultconnection.logger.debug("start now: "+this.start+", lastpage: "+lastpage);if(Math.floor(this.start/this.perPage)>lastpage){mljs.defaultconnection.logger.debug("new page greater than maxpage");this.start=1+Math.floor(this.perPage*(lastpage-1));mljs.defaultconnection.logger.debug("start now now: "+this.start);}
this._fire();};com.marklogic.widgets.searchpager.prototype._last=function(){var lastpage=1+Math.floor(this.total/this.perPage);this.start=1+Math.floor(this.perPage*(lastpage-1));this._fire();};com.marklogic.widgets.searchsort=function(container){this.container=container;this.ctx=mljs.defaultconnection.createSearchContext();this.initialised=false;this.selectedValue=null;this.selectionPublisher=new com.marklogic.events.Publisher();this.sortOptions=new Array();this._refresh();};com.marklogic.widgets.searchsort.prototype.setContext=function(context){this.ctx=context;};com.marklogic.widgets.searchsort.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchsort.prototype._refresh=function(){var selid=this.container+"-searchsort-select";var str="<div class='mljswidget searchsort'><span class='searchsort-text'>Sort: </span>"+"<select class='searchsort-select' id='"+selid+"'>";for(var i=0;i<this.sortOptions.length;i++){var selected=false;if(this.selectedValue==null){selected=true;this.selectedValue=this.sortOptions[i];}else{selected=((this.selectedValue["json-key"]==this.sortOptions[i]["json-key"])&&(this.selectedValue["element"]==this.sortOptions[i]["element"])&&(this.selectedValue["attribute"]==this.sortOptions[i]["attribute"])&&(this.selectedValue["field"]==this.sortOptions[i]["field"])&&(this.selectedValue["direction"]==this.sortOptions[i]["direction"]))}
var o=this.sortOptions[i];str+="<option value='"+i+"'";if(selected){str+=" selected='selected'";}
str+=">";var title="";var val="";if(undefined!=o["json-key"]){val=o["json-key"];}
if(undefined!=o.element){if(undefined!=o.attribute){val=o["attribute"];}else{val=o["element"];}}
if(undefined!=o.field){val=o["field"];}
if(undefined!=o.annotation&&undefined!=o.annotation[0]){title=o.annotation[0];}
if(""==title){title=com.marklogic.widgets.searchhelper.processValueAll(val);if(""!=title&&undefined!=o.direction){title+=" ("+com.marklogic.widgets.searchhelper.camelcase(o.direction,"all")+")";}else{}}
if(""==title){title="None";}
str+=title;}
str+="</select></div>";document.getElementById(this.container).innerHTML=str;var self=this;var sel=document.getElementById(selid);sel.onchange=function(evt){self._updateSortSelect(sel.value);};};com.marklogic.widgets.searchsort.prototype._updateSortSelect=function(index){var value=this.sortOptions[index];this.selectedValue=value;mljs.defaultconnection.logger.debug("searchsort: publishing selected sort option: "+JSON.stringify(value));this.selectionPublisher.publish(value);};com.marklogic.widgets.searchsort.prototype.addSortListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchsort.prototype.removeSortListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchsort.prototype.updateSort=function(sortSelection){};com.marklogic.widgets.searchsort.prototype.updateOptions=function(options){mljs.defaultconnection.logger.debug("searchsort: updateOptions: "+JSON.stringify(options));mljs.defaultconnection.logger.debug("searchsort: initalised yet?: "+this.initialised);if(this.initialised)return;this.initialised=true;var so=options["sort-order"];this.sortOptions=new Array();if(undefined!=so){for(var i=0;i<so.length;i++){this.sortOptions.push(so[i]);}}
this._refresh();};com.marklogic.widgets.selection=function(container){this.container=container;this._selected=new Array();this._refresh();};com.marklogic.widgets.selection.prototype._refresh=function(){var str="<div id='"+this.container+"-selection' class='mljswidget selection'>";str+="<div class='title selection-title'>Selected Documents</div>";if(0==this._selected.length){str+="<i>None Selected</i>";}else{for(var i=0,max=this._selected.length,sel;i<max;i++){sel=this._selected[i];str+="<p>"+sel+"</p>";}}
str+="</div>";document.getElementById(this.container).innerHTML=str;};com.marklogic.widgets.selection.prototype.updateDocumentSelection=function(newsel){this._selected=newsel;this._refresh();};com.marklogic.widgets.searchpage=function(container){this.container=container;document.getElementById(container).innerHTML="<div class='container_12 searchpage-inner'>"+"<div id='"+container+"-facets' class='grid_4 searchpage-facets'> </div> "+"<div id='"+container+"-main' class='grid_8 searchpage-main'>"+"<div id='"+container+"-bar' class='searchpage-bar'></div>"+"<div id='"+container+"-error' class='searchpage-error'></div>"+"<div class='grid_8 searchpage-controls'>"+"<div class='searchpage-controls-inner'>"+"<div id='"+container+"-pager' class='grid_5 alpha searchpage-pager'></div>"+"<div id='"+container+"-sort' class='grid_3 omega searchpage-sort'></div>"+"</div>"+"</div>"+"<div id='"+container+"-results' class='grid_8 searchpage-results'></div>"+"<div id='"+container+"-results-actions' class='grid_8 searchpage-results-actions'></div>"+"</div></div>";this.context=mljs.defaultconnection.createSearchContext();this.bar=new com.marklogic.widgets.searchbar(container+"-bar");this.facets=new com.marklogic.widgets.searchfacets(container+"-facets");this.pager=new com.marklogic.widgets.searchpager(container+"-pager");this.sort=new com.marklogic.widgets.searchsort(container+"-sort");this.results=new com.marklogic.widgets.searchresults(container+"-results");this.error=new com.marklogic.widgets.error(container+"-error");var self=this;this.context.register(this.bar);this.context.register(this.sort);this.context.register(this.facets);this.context.register(this.pager);this.context.register(this.results);this.db=mljs.defaultconnection;};com.marklogic.widgets.searchpage.prototype.setSearchContext=function(ctx){this.context=ctx;this.context.register(this.bar);this.context.register(this.sort);this.context.register(this.facets);this.context.register(this.pager);this.context.register(this.results);};com.marklogic.widgets.searchpage.prototype.getSearchContext=function(){return this.context;};com.marklogic.widgets.searchpage.prototype.setOptions=function(name,options,check_options_exist){this.context.setOptions(name,options);};com.marklogic.widgets.searchpage.prototype.execute=function(){this.context.dosimplequery();};com.marklogic.widgets.searchpage.prototype.setConnection=function(connection){this.db=connection;this.context.setConnection(connection);};com.marklogic.widgets.searchpage.reset=function(){this.context.reset();};com.marklogic.widgets.searchselection=function(container){this.container=container;this._config={title:"Relevancy Method: "};this._mode="replace";this._queries={};this._selectedQuery=null;this._refresh();this.ctx=mljs.defaultconnection.createSearchContext();};com.marklogic.widgets.searchselection.prototype.setContext=function(ctx){this.ctx=ctx;};com.marklogic.widgets.searchselection.prototype.getContext=function(){return this.ctx;};com.marklogic.widgets.searchselection.prototype._config=function(){};com.marklogic.widgets.searchselection.prototype._refresh=function(){var selid=this.container+"-searchselection-select";var str="<div id='"+this.container+"-searchselection' class='mljswidget searchselection'>";str+="<span class='searchselection-text'>"+this._config.title+"</span>"+"<select class='searchselection-select' id='"+selid+"'>";for(var name in this._queries){str+="<option value='"+name+"'";if(name==this._selectedQuery){str+=" selected='selected'";}
str+=">"+name+"</option>";}
str+="</select>";str+="</div>";document.getElementById(this.container).innerHTML=str;var self=this;var sel=document.getElementById(selid);sel.onchange=function(evt){self.__selection(sel.value);};};com.marklogic.widgets.searchselection.prototype.addQuery=function(name,jsonOrFunction){this._queries[name]=jsonOrFunction;this._refresh();};com.marklogic.widgets.searchselection.prototype.removeQuery=function(name){this._queries[name]=undefined;this._refresh();};com.marklogic.widgets.searchselection.prototype.__selection=function(selvalue){this._selectedQuery=selvalue;this.__doquery();};com.marklogic.widgets.searchselection.prototype.__doquery=function(){if(null==this._selectedQuery){var first=null;for(var name in this._queries){if(null==first){first=name;}}
if(null==first){return;}else{this._selectedQuery=first;this._refresh();}}
var q=this._queries[this._selectedQuery];var query=null;if("function"===typeof(q)){mljs.defaultconnection.logger.debug("searchselection.__doquery: Calling query function");query=q();}else if("object"===typeof(q)){mljs.defaultconnection.logger.debug("searchselection.__doquery: Setting query value");query=q;}
mljs.defaultconnection.logger.debug("searchselection.__doquery: Query now: "+JSON.stringify(query));if("contribute"==this._mode){mljs.defaultconnection.logger.debug("searchselection.__doquery: Contributing Query");this.ctx.contributeStructuredQuery(this.container,query,1);}else{mljs.defaultconnection.logger.debug("searchselection.__doquery: Overwriting Query");this.ctx.doStructuredQuery(query);}};com.marklogic.widgets.searchselection.prototype.setModeContributeStructured=function(){this._mode="contribute";};