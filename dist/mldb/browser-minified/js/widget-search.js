
com=window.com||{};com.marklogic=window.com.marklogic||{};com.marklogic.widgets=window.com.marklogic.widgets||{};com.marklogic.widgets.searchhelper={};com.marklogic.widgets.searchhelper.processValueAll=function(str){return com.marklogic.widgets.searchhelper.processValue(str,"all");};com.marklogic.widgets.searchhelper.processValue=function(str,mode){var name=str;name=com.marklogic.widgets.searchhelper.splitdash(name,mode);name=com.marklogic.widgets.searchhelper.splitunderscore(name,mode);name=com.marklogic.widgets.searchhelper.camelcase(name,mode);return name;};com.marklogic.widgets.searchhelper.splitdash=function(value,mode){if(value==undefined||value==null){mldb.defaultconnection.logger.warn("WARNING: splitdash(): value is "+value);return"";}
if("string"!=typeof value){mldb.defaultconnection.logger.warn("WARNING: splitdash(): value is not of type string, but of type '"+(typeof value)+"'");return"";}
var name=value;if("all"==mode||"splitdash"==mode){var parts=name.split("-");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i]+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.splitunderscore=function(value,mode){var name=value;if("all"==mode||"splitunderscore"==mode){var parts=name.split("_");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i]+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchhelper.camelcase=function(value,mode){var name=value;if("all"==mode||"camelcase"==mode){var parts=name.split(" ");var nn="";for(var i=0;i<parts.length;i++){nn+=parts[i].substring(0,1).toUpperCase()+parts[i].substring(1)+" ";}
name=nn.trim();}
return name;};com.marklogic.widgets.searchbar=function(container){if(undefined==com.marklogic.widgets.searchbar.list){com.marklogic.widgets.searchbar.list=new Array();}
this.container=container;this.sortWord="sort";this.defaultQuery="";this.optionsName=mldb.__dogenid();this.optionsExists=false;this.collection=null;this.directory=null;this.transform=null;this.format=null;this.options={options:{"return-results":true,"page-length":10,"transform-results":{apply:"raw"},constraint:[{"name":"collection","collection":{"prefix":""}}]}};this.resultsPublisher=new com.marklogic.events.Publisher();this.facetsPublisher=new com.marklogic.events.Publisher();this.sortPublisher=new com.marklogic.events.Publisher();this.errorPublisher=new com.marklogic.events.Publisher();mldb.defaultconnection.logger.debug("adding search bar html");document.getElementById(container).innerHTML="<div class='searchbar-inner'>"+"<div class='searchbar-queryrow'>"+"<label class='searchbar-label' for='"+container+"-searchinput'>Search: </label>"+"<input class='searchbar-query' type='text' id='"+container+"-searchinput' value='' />"+"<input class='searchbar-submit' type='submit' id='"+container+"-submit' value='Search' />"+"</div><div class='searchbar-errorrow hidden'></div>";"</div>";mldb.defaultconnection.logger.debug("adding submit click handler");var self=this;document.getElementById(container+"-submit").onclick=function(){self._dosearch(self);};mldb.defaultconnection.logger.debug("added submit click handler");this.db=mldb.defaultconnection;};com.marklogic.widgets.searchbar.prototype.setTransform=function(t){this.transform=t;};com.marklogic.widgets.searchbar.prototype.setFormat=function(f){this.format=f;};com.marklogic.widgets.searchbar.prototype.setCollection=function(col){this.collection=col;};com.marklogic.widgets.searchbar.prototype.setDirectory=function(dir){this.directory=dir;};com.marklogic.widgets.searchbar.prototype.setOptions=function(options){this.options=options;this.optionsExists=false;};com.marklogic.widgets.searchbar.prototype.setOptionsName=function(name){this.optionsName=name;};com.marklogic.widgets.searchbar.prototype.setDefaultQuery=function(defQuery){this.defaultQuery=defQuery;var qel=document.getElementById(this.container+"-searchinput");var q=qel.getAttribute("value");if(null==q||undefined==q||"".equals(q.trim())){qel.setAttribute("value",this.defaultQuery);}};com.marklogic.widgets.searchbar.prototype.setConnection=function(connection){this.db=connection;};com.marklogic.widgets.searchbar.__dosearch=function(submitelement){var id=submitelement.getAttribute("id");id=id.substring(0,id.length-12);var bar=com.marklogic.widgets.searchbar.list[id];if(null==id){mldb.defaultconnection.logger.debug("searchbar.__dosearch - search bar instance does not exist: "+id);}else{bar._dosearch();}};com.marklogic.widgets.searchbar.prototype._parseQuery=function(q){var text="";var facets=new Array();var sort=null;var parts=q.split(" ");for(var i=0;i<parts.length;i++){if(0==parts[i].indexOf(this.sortWord+":")){sort=parts[i].substring(5);}else if(-1!=parts[i].indexOf(":")){mldb.defaultconnection.logger.debug("FOUND A FACET IN QUERY: "+parts[i]);var fv=parts[i].split(":");mldb.defaultconnection.logger.debug("Facet name: "+fv[0]+" value: "+fv[1]);if(0==fv[1].indexOf("\"")){fv[1]=fv[1].substring(1);if((fv[1].length-1)==fv[1].indexOf("\"")){fv[1]=fv[1].substring(0,fv[1].length-1);}}
mldb.defaultconnection.logger.debug("Facet info now name: "+fv[0]+" value: "+fv[1]);var found=false;for(var f=0;f<facets.length;f++){if(facets[f].name==fv[0]){facets[f].value=fv[1];found=true;}}
if(!found){facets.push({name:fv[0],value:fv[1]});}}else{text+=" "+parts[i];}}
return{q:text.trim(),facets:facets,sort:sort};};com.marklogic.widgets.searchbar.prototype._queryToText=function(parsed){var q=parsed.q;if(null!=parsed.sort){q+=" "+this.sortWord+":"+parsed.sort;}
for(var i=0;i<parsed.facets.length;i++){q+=" "+parsed.facets[i].name+":\""+parsed.facets[i].value+"\"";}
return q;};com.marklogic.widgets.searchbar.prototype.clear=function(){document.getElementById(this.container+"-searchinput").value="";};com.marklogic.widgets.searchbar.prototype.execute=function(){var q=document.getElementById(this.container+"-searchinput").value;this.__doquery(q);};com.marklogic.widgets.searchbar.prototype._dosearch=function(self){var q=document.getElementById(self.container+"-searchinput").value;self.__doquery(q);};com.marklogic.widgets.searchbar.prototype.__doquery=function(q,start){var self=this;self.resultsPublisher.publish(true);self.facetsPublisher.publish(true);var ourstart=1;if(0!=start&&undefined!=start){ourstart=start;}
mldb.defaultconnection.logger.debug("Query before: "+q);var parsed=self._parseQuery(q);mldb.defaultconnection.logger.debug("Query parsed: "+JSON.stringify(parsed));var cq=self._queryToText(parsed);q=cq;mldb.defaultconnection.logger.debug("Query after: "+cq);document.getElementById(this.container+"-searchinput").value=cq;self.facetsPublisher.publish(parsed.facets);var dos=function(){var sprops={};if(null!=self.collection){sprops.collection=self.collection;}
if(null!=self.directory){sprops.directory=self.directory;}
if(null!=self.transform){sprops.transform=self.transform;}
if(null!=self.format){sprops.format=self.format;}
self.db.search(q,self.optionsName,ourstart,sprops,function(result){if(result.inError){mldb.defaultconnection.logger.debug(result.error);self.resultsPublisher.publish(false);}else{self.resultsPublisher.publish(result.doc);}});};if(!this.optionsExists){this.db.saveSearchOptions(this.optionsName,this.options,function(result){if(result.inError){mldb.defaultconnection.logger.debug(result.error);}else{self.optionsExists=true;dos();}});}else{dos();}};com.marklogic.widgets.searchbar.prototype.setSortWord=function(word){this.sortWord=word;};com.marklogic.widgets.searchbar.prototype.addResultsListener=function(rl){this.resultsPublisher.subscribe(rl);};com.marklogic.widgets.searchbar.prototype.removeResultsListener=function(rl){this.resultsPublisher.unsubscribe(rl);};com.marklogic.widgets.searchbar.prototype.addSortListener=function(sl){this.sortPublisher.subscribe(sl);};com.marklogic.widgets.searchbar.prototype.removeSortListener=function(sl){this.sortPublisher.unsubscribe(sl);};com.marklogic.widgets.searchbar.prototype.addFacetsListener=function(fl){this.facetsPublisher.subscribe(fl);};com.marklogic.widgets.searchbar.prototype.removeFacetsListener=function(fl){this.facetsPublisher.unsubscribe(fl);};com.marklogic.widgets.searchbar.prototype.addErrorListener=function(fl){this.errorPublisher.subscribe(fl);};com.marklogic.widgets.searchbar.prototype.removeErrorListener=function(fl){this.errorPublisher.unsubscribe(fl);};com.marklogic.widgets.searchbar.prototype.updateFacets=function(facetSelection){var q=document.getElementById(this.container+"-searchinput").value;var parsed=this._parseQuery(q);parsed.facets=facetSelection;q=this._queryToText(parsed);this.__doquery(q);};com.marklogic.widgets.searchbar.prototype.updatePage=function(json){if(this.options.options["page-length"]!=json.show){this.optionsExists=false;this.options.options["page-length"]=json.show;}
var q=document.getElementById(this.container+"-searchinput").value;this.__doquery(q,json.start);};com.marklogic.widgets.searchbar.prototype.updateSort=function(sortSelection){var q=document.getElementById(this.container+"-searchinput").value;q+=" "+this.sortWord+":"+sortSelection;this.__doquery(q);};com.marklogic.widgets.searchbar.prototype.reset=function(){this.resultsPublisher.publish(null);this.facetsPublisher.publish(null);this.sortPublisher.publish(null);document.getElementById(this.container+"-searchinput").setAttribute("value",this.defaultQuery);};com.marklogic.widgets.searchfacets=function(container){this.container=container;this.listSize=5;this.extendedSize=10;this.allowShowAll=true;this.facetSettings=new Array();this.hideEmptyFacets=true;this.results=null;this.selected=new Array();this.facetNameTransform="all";this.facetValueTransform="all";this.selectionPublisher=new com.marklogic.events.Publisher();this._refresh();};com.marklogic.widgets.searchfacets.prototype._setFacetSettings=function(facetName,extended,showall){var json={extended:extended,showAll:showAll};this.facetSettings[facetName]=json;};com.marklogic.widgets.searchfacets.prototype._getFacetSettings=function(facetName){var res=this.facetSettings[facetName];if(undefined==res||null==res){return{extended:false,showAll:false};}else{return res;}};com.marklogic.widgets.searchfacets.prototype.clear=function(){this.results=null;this._refresh();};com.marklogic.widgets.searchfacets.prototype._refresh=function(){if(false==this.results||true==this.results){return;}
var more=new Array();var extended=new Array();var str="<div class='searchfacets-title'>Browse</div> <div id='"+this.container+"-facetinfo' class='search-facets'> ";var deselectionTodo=new Array();if(0!=this.selected.length){str+="<div class='searchfacets-selected'>";for(var i=0;i<this.selected.length;i++){var s=this.selected[i];str+="<div class='searchfacets-selection'>"+"<a href='#' class='searchfacets-deselect' id='"+this.container+"-desel-"+s.name+"-"+s.value+"'>X</a> "+
this._transformFacetName(s.name)+": "+this._transformFacetValue(s.value)+"</div>";deselectionTodo.push(s);}
str+="</div>";}
var facetHandlersTodo=new Array();if(null!=this.results&&undefined!=this.results){if(undefined!=this.results.facets){for(var name in this.results.facets){var facetStr="<div class='searchfacets-facet'><div class='searchfacets-facet-title'>"+this._transformFacetName(name)+"</div>"+"<div class='searchfacets-facet-values'>";var settings=this._getFacetSettings(name);var max=this.listSize;var values=this.results.facets[name].facetValues;bubbleSort(values,"count");var valuesCount=values.length;if(settings.more){max=this.extendedSize;}
if(settings.showAll&&settings.extended){max=valuesCount;}
for(var v=0;v<max&&v<valuesCount;v++){if(v<this.listSize||(v<this.extendedSize&&settings.extended)||settings.showAll){var fv=values[v];facetStr+="<div class='searchfacets-facet-value' id='"+this.container+"-fv-"+name+"-"+fv.name+"'>"+this._transformFacetValue(fv.name)+" ("+fv.count+")"+"</div>";facetHandlersTodo.push({name:name,value:fv.name});}}
if(valuesCount>this.listSize){if(!settings.extended){facetStr+="<div class='searchfacets-more'><a href='#' id='"+this.container+"-"+name+"-more-link'>More...</a></div>";more.push(name);}else{if(valuesCount>this.extendedSize&&!settings.showAll&&this.allowShowAll){extended.push(name);}}}
facetStr+="</div></div>";if(!(0==valuesCount&&this.hideEmptyFacets)){str+=facetStr;}}}}
str+="</div>";document.getElementById(this.container).innerHTML=str;var self=this;var addfh=function(fh){var el=document.getElementById(self.container+"-fv-"+fh.name+"-"+fh.value);if(undefined!=el){el.onclick=function(){self._selectFacet(fh.name,fh.value)};}};for(var i=0;i<facetHandlersTodo.length;i++){var fh=facetHandlersTodo[i];addfh(fh);}
var remfh=function(fh){var el=document.getElementById(self.container+"-desel-"+fh.name+"-"+fh.value);if(undefined!=el){el.onclick=function(){self._deselectFacet(fh.name,fh.value)};}};for(var i=0;i<deselectionTodo.length;i++){var fh=deselectionTodo[i];remfh(fh);}
for(var i=0;i<more.length;i++){document.getElementById(this.container+"-"+more[i]+"-more-link").onclick=function(){self._more(more[i]);};}
for(var i=0;i<extended.length;i++){document.getElementById(this.container+"-"+extended[i]+"-extended-link").onclick=function(){self._extended(extended[i]);};}};com.marklogic.widgets.searchfacets.prototype._selectFacet=function(facetName,value){mldb.defaultconnection.logger.debug("Selecting "+facetName+":"+value);this.selected.push({name:facetName,value:value});this._refresh();this.selectionPublisher.publish(this.selected);};com.marklogic.widgets.searchfacets.prototype._deselectFacet=function(facetName,value){mldb.defaultconnection.logger.debug("Deselecting "+facetName+":"+value);var newsel=new Array();for(var i=0;i<this.selected.length;i++){var el=this.selected[i];if(el.name==facetName&&el.value==value){}else{newsel.push(el);}}
this.selected=newsel;this._refresh();this.selectionPublisher.publish(this.selected);};com.marklogic.widgets.searchfacets.prototype._transformFacetName=function(facetName){return com.marklogic.widgets.searchhelper.processValue(facetName,this.facetNameTransform);};com.marklogic.widgets.searchfacets.prototype._transformFacetValue=function(facetValue){return com.marklogic.widgets.searchhelper.processValue(facetValue,this.facetValueTransform);};com.marklogic.widgets.searchfacets.prototype._more=function(facetName){this._setFacetSettings(facetName,true,false);this._refresh();};com.marklogic.widgets.searchfacets.prototype._extended=function(facetName){this._setFacetSettings(facetName,false,true);this._refresh();};com.marklogic.widgets.searchfacets.prototype.setSizes=function(listSize,extendedSize){this.listSize=listSize;this.extendedSize=extendedSize;};com.marklogic.widgets.searchfacets.prototype.setAllowShowAll=function(boolvalue){this.allowShowAll=boolvalue;};com.marklogic.widgets.searchfacets.prototype.addSelectionListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchfacets.prototype.removeSelectionListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchfacets.prototype.updateFacets=function(results){if("boolean"==typeof results){return;}
this.results=results;this._refresh();};com.marklogic.widgets.searchfacets.prototype.updateSelectedFacets=function(facets){mldb.defaultconnection.logger.debug("In updateSelectedFacets(facets): "+JSON.stringify(facets));this.selected=facets;this._refresh();};com.marklogic.widgets.searchresults=function(container){this.container=container;this.results=null;this.processors=new Array();this.availableProcessors=new Array();this.processorPriority=new Array();this.detailsLink=null;var htmlRec=function(content){var resStr="";console.log("type of content: "+(typeof content));if("string"==typeof content){return content;}else{for(var tag in content){console.log("processing tag: "+tag);resStr+="<"+tag;if(undefined!=content[tag].class){resStr+=" class='"+content[tag].class+"'";content[tag].class=undefined;}
if(undefined!=content[tag].id){resStr+=" id='"+content[tag].id+"'";content[tag].id=undefined;}
resStr+=">";console.log("calling htmlRec for tag: "+tag);resStr+=htmlRec(content[tag]);resStr+="</"+tag+">";}
return resStr;}};this.defaultProcessor={matcher:function(result){return true;},processor:function(result){console.log("matches:"+result.matches);console.log("first match: "+result.matches[0]);console.log("match text: "+result.matches[0]["match-text"]);console.log("match text 0: "+result.matches[0]["match-text"][0]);if("object"==typeof result.content&&undefined!=result.content.html){var content=result.content.html.body;var resStr=htmlRec(content);}else if(undefined!=result.matches&&result.matches[0]&&result.matches[0]["match-text"]&&result.matches[0]["match-text"][0]&&result.matches[0]["match-text"][0].indexOf("<html")==0){console.log("GOT A SNIPPET MATCH WITH A HTML ELEMENT");var xml=textToXML(result.matches[0]["match-text"][0]);var txt=result.matches[0]["match-text"][0];console.log("RAW HTML TEXT: "+txt);var strip=txt.substring(txt.indexOf(">",txt.indexOf("<body")+5)+1,txt.indexOf("</body>"));console.log("STRIP TEXT: "+strip);var title=null;var titleEl=xml.getElementsByTagName("title")[0];console.log("PATH: "+result.matches[0].path);if(undefined!=titleEl&&null!=titleEl&&null!=titleEl.nodeValue){title=titleEl.nodeValue;}else{title=result.matches[0].path.substring(8,result.matches[0].path.length-2);}
var resStr="<div class='searchresults-result'><h3>"+result.index+". "+title+"</h3>";resStr+="<div class='searchresults-snippet'>"+strip+"</div>";resStr+="</div>";return resStr;}else{var resStr="";var title=result.uri;if(undefined!=result.content&&undefined!=result.content.title){title=result.content.title;}
var snippet=null;if(undefined!=result.content&&undefined!=result.content.summary){snippet=result.content.summary;}else if(undefined!=result.content){snippet=JSON.stringify(result.content);}else{}
resStr+="<div class='searchresults-result'><h3>"+result.index+". "+title+"</h3>";if(null!=snippet){resStr+="<div class='searchresults-snippet'>"+snippet+"</div>";}
resStr+="</div>";return resStr;}}};this._refresh();this.selectionPublisher=new com.marklogic.events.Publisher();};com.marklogic.widgets.searchresults.prototype.details=function(urlspec){this.detailsLink=urlspec;};com.marklogic.widgets.searchresults.prototype.clear=function(){this.results=null;this._refresh();};com.marklogic.widgets.searchresults.prototype.updateResults=function(results){this.results=results;this._refresh();};com.marklogic.widgets.searchresults.prototype._refresh=function(){if(typeof this.results=="boolean"){return;}
if(null==this.results||undefined==this.results.results||this.results.results.length==0){document.getElementById(this.container).innerHTML="<div class='searchresults-inner'>"+"<div class='searchresults-title'>Results</div><div class='searchresults-results'>No Results</div>"+"</div>";}else{mldb.defaultconnection.logger.debug("RESULTS OBJECT: "+JSON.stringify(this.results));var resStr="<div class='searchresults-inner'><div class='searchresults-title'>Results</div><div class='searchresults-results'>";var uureplace=1001;var replacements=new Array();var pointer=null!=this.detailsLink;for(var i=0;i<this.results.results.length;i++){resStr+="<div id='"+this.container+"-searchresults-wrapper-"+i+"' class='searchresults-wrapper"
if(pointer){resStr+=" searchresults-navigable";}
resStr+="'>";var result=this.results.results[i];var found=false;for(var p=0;!found&&p<this.processorPriority.length;p++){var pname=this.processorPriority[p];mldb.defaultconnection.logger.debug("checking applicability of processor: "+pname);if(this.processors[pname].matcher(result)){found=true;mldb.defaultconnection.logger.debug("found processor: "+pname);var returned=this.processors[pname].processor(result);if(undefined!=returned.nodeType){var id=(uureplace++);resStr="<div id='"+this.container+"-searchresults-xml-"+id+"'></div>";replacements[id]=returned;}else{resStr+=returned;}}}
if(!found){mldb.defaultconnection.logger.debug("No processor found, using default");resStr+=this.defaultProcessor.processor(result);}
resStr+="</div>";}
resStr+="</div></div>";mldb.defaultconnection.logger.debug("RES STR: "+resStr);document.getElementById(this.container).innerHTML=resStr;if(pointer){var self=this;var addPointerHandler=function(id,result){document.getElementById(id).onclick=function(evt){self._navigateTo(result.uri);}}
for(var i=0;i<this.results.results.length;i++){var id=this.container+"-searchresults-wrapper-"+i;var result=this.results.results[i];addPointerHandler(id,result);}}
for(var r=1001;r<uureplace;r++){document.getElementById(this.container+"-searchresults-xml-"+r).innerHTML=replacements[r];}}};com.marklogic.widgets.searchresults.prototype._navigateTo=function(uri){var go=this.detailsLink.replace("#URI#",uri);window.location=go;};com.marklogic.widgets.searchresults.prototype.addSelectionListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchresults.prototype.removeSelectionListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchresults.prototype.addProcessor=function(name,matcher_func,processor_func){this.processors[name]={matcher:matcher_func,processor:processor_func};this.availableProcessors.push(name);this.processorPriority.push(name);};com.marklogic.widgets.searchresults.prototype.removeProcessor=function(name){this.processors[name]=undefined;this.availableProcessors.remove(name);this.processorPriority.remove(name);};com.marklogic.widgets.searchresults.prototype.setProcessorPriority=function(procNameArray){this.processorPriority=procNameArray;};com.marklogic.widgets.searchpager=function(container){this.container=container;this.perPage=10;this.start=0;this.total=0;this.pagePublisher=new com.marklogic.events.Publisher();document.getElementById(container).innerHTML="<span class='searchpager-showing' id='"+container+"-searchpager-showing'></span>"+"<span class='searchpager-first searchpager-button' id='"+container+"-searchpager-first'><a href='#' id='"+container+"-searchpager-first-a' class='searchpager-link'>&lt;&lt;  </a></span>"+"<span class='searchpager-previous searchpager-button' id='"+container+"-searchpager-previous'><a href='#' id='"+container+"-searchpager-previous-a' class='searchpager-link'>&lt;  </a></span>"+"<span class='searchpager-page' id='"+container+"-searchpager-page'>-</span>"+"<span class='searchpager-next searchpager-button' id='"+container+"-searchpager-next'><a href='#' id='"+container+"-searchpager-next-a' class='searchpager-link'>  &gt;</a></span>"+"<span class='searchpager-last searchpager-button' id='"+container+"-searchpager-last'><a href='#' id='"+container+"-searchpager-last-a' class='searchpager-link'>  &gt;&gt;</a></span>";var self=this;document.getElementById(container+"-searchpager-first-a").onclick=function(){self._first();};document.getElementById(container+"-searchpager-previous-a").onclick=function(){self._previous();};document.getElementById(container+"-searchpager-next-a").onclick=function(){self._next();};document.getElementById(container+"-searchpager-last-a").onclick=function(){self._last();};this._refresh();};com.marklogic.widgets.searchpager.prototype.clear=function(){this.updatePage(null);};com.marklogic.widgets.searchpager.prototype.updatePage=function(results){mldb.defaultconnection.logger.debug("updatePage: results: "+results);if("boolean"==typeof results){return;}
if(null==results){this.start=1;this.total=0;}else{this.perPage=results["page-length"];this.start=results.start;this.total=results.total;}
this._refresh();};com.marklogic.widgets.searchpager.prototype.addPageListener=function(l){this.pagePublisher.subscribe(l);};com.marklogic.widgets.searchpager.prototype.removePageListener=function(l){this.pagePublisher.unsubscribe(l);};com.marklogic.widgets.searchpager.prototype._refresh=function(){mldb.defaultconnection.logger.debug("REFRESH: start: "+this.start+", total: "+this.total+", perPage: "+this.perPage);var last=(this.start+this.perPage-1);if(last>this.total){last=this.total;}
var st=this.start;if(st>this.total){st=this.total;}
if(0==st){document.getElementById(this.container+"-searchpager-showing").innerHTML="Showing no results";}else{document.getElementById(this.container+"-searchpager-showing").innerHTML="Showing "+st+" to "+last+" of "+this.total;}
var page=1+Math.floor(st/this.perPage);var maxpage=1+Math.floor(this.total/this.perPage);if(0==st){page=0;maxpage=0;}
if(0==page){document.getElementById(this.container+"-searchpager-page").innerHTML=" - ";}else{document.getElementById(this.container+"-searchpager-page").innerHTML="Page "+page+" of "+maxpage;}
if(page<2){}else if(page==maxpage){}};com.marklogic.widgets.searchpager.prototype._fire=function(){this._refresh();var json={start:this.start,show:this.perPage};this.pagePublisher.publish(json);};com.marklogic.widgets.searchpager.prototype._first=function(){this.start=1;this._fire();};com.marklogic.widgets.searchpager.prototype._previous=function(){this.start=this.start-this.perPage;if(this.start<1){this.start=1;}
this._fire();};com.marklogic.widgets.searchpager.prototype._next=function(){this.start=this.start+this.perPage;var lastpage=1+Math.floor(this.total/this.perPage);mldb.defaultconnection.logger.debug("start now: "+this.start+", lastpage: "+lastpage);if(Math.floor(this.start/this.perPage)>lastpage){mldb.defaultconnection.logger.debug("new page greater than maxpage");this.start=1+Math.floor(this.perPage*(lastpage-1));mldb.defaultconnection.logger.debug("start now now: "+this.start);}
this._fire();};com.marklogic.widgets.searchpager.prototype._last=function(){var lastpage=1+Math.floor(this.total/this.perPage);this.start=1+Math.floor(this.perPage*(lastpage-1));this._fire();};com.marklogic.widgets.searchsort=function(container){this.container=container;this.selectionPublisher=new com.marklogic.events.Publisher();this.sortOptions=new Array();this.sortOptions.push({title:"None",value:""});this._refresh();};com.marklogic.widgets.searchsort.prototype._refresh=function(){var str="<span class='searchsort-text'>Sort: </span>"+"<select class='searchsort-select'>";for(var i=0;i<this.sortOptions.length;i++){var o=this.sortOptions[i];str+="<option value='"+o.value+"'>";if(undefined!=o.title){str+=o.title;}else{str+=com.marklogic.widgets.searchhelper.processValueAll(o.value);}}
str+="</select>";document.getElementById(this.container).innerHTML=str;};com.marklogic.widgets.searchsort.prototype.addSelectionListener=function(sl){this.selectionPublisher.subscribe(sl);};com.marklogic.widgets.searchsort.prototype.removeSelectionListener=function(sl){this.selectionPublisher.unsubscribe(sl);};com.marklogic.widgets.searchsort.prototype.updateSort=function(sortSelection){};com.marklogic.widgets.searchsort.prototype.setOptions=function(options){var so=options.options["sort-order"];this.sortOptions=new Array();this.sortOptions.push({title:"None",value:""});if(undefined!=so){for(var i=0;i<so.length;i++){var key=so[i]["json-key"];if(undefined!=key){this.sortOptions.push({value:key,order:so[i]["direction"]});}}}
this._refresh();};com.marklogic.widgets.searchpage=function(container){this.container=container;document.getElementById(container).innerHTML="<div class='container_12 searchpage-inner'>"+"<div id='"+container+"-facets' class='grid_4 searchpage-facets'> </div> "+"<div id='"+container+"-main' class='grid_8 searchpage-main'>"+"<div id='"+container+"-bar' class='searchpage-bar'></div>"+"<div id='"+container+"-error' class='searchpage-error'></div>"+"<div class='grid_8 searchpage-controls'>"+"<div class='searchpage-controls-inner'>"+"<div id='"+container+"-pager' class='grid_6 alpha searchpage-pager'></div>"+"<div id='"+container+"-sort' class='grid_2 omega searchpage-sort'></div>"+"</div>"+"</div>"+"<div id='"+container+"-results' class='grid_8 searchpage-results'></div>"+"<div id='"+container+"-results-actions' class='grid_8 searchpage-results-actions'></div>"+"</div></div>";this.bar=new com.marklogic.widgets.searchbar(container+"-bar");this.facets=new com.marklogic.widgets.searchfacets(container+"-facets");this.pager=new com.marklogic.widgets.searchpager(container+"-pager");this.sort=new com.marklogic.widgets.searchsort(container+"-sort");this.results=new com.marklogic.widgets.searchresults(container+"-results");this.error=new com.marklogic.widgets.error(container+"-error");var self=this;this.bar.addResultsListener(function(res){self.results.updateResults(res);});this.bar.addResultsListener(function(res){self.pager.updatePage(res);});this.bar.addResultsListener(function(obj){self.facets.updateFacets(obj);});this.bar.addSortListener(function(obj){self.sort.updateSort(obj);});this.bar.addFacetsListener(function(obj){self.facets.updateSelectedFacets(obj);});this.sort.addSelectionListener(function(obj){self.bar.updateSort(obj);});this.facets.addSelectionListener(function(obj){self.bar.updateFacets(obj);});this.pager.addPageListener(function(obj){self.bar.updatePage(obj);});this.bar.addErrorListener(function(obj){this.error.updateError(obj);this.facets.clear();this.results.clear();this.page.clear();});this.db=mldb.defaultconnection;};com.marklogic.widgets.searchpage.prototype.setOptions=function(name,options,check_options_exist){this.bar.setOptionsName(name);this.bar.setOptions(options);this.sort.setOptions(options);var self=this;if(undefined!=check_options_exist&&true==check_options_exist){mldb.defaultconnection.searchoptions(name,function(result){console.log("RESULT: "+JSON.stringify(result.doc));if(result.inError){console.log("Search options "+name+" do not exist on the server. Search bar widget will auto create them on next search.");console.log("ERROR: "+JSON.stringify(result.details));}else{self.bar.setOptions(result.doc);self.sort.setOptions(result.doc);self.bar.optionsExists=true;}});}};com.marklogic.widgets.searchpage.prototype.execute=function(){this.bar.execute();};com.marklogic.widgets.searchpage.prototype.setConnection=function(connection){this.db=connection;this.bar.setConnection(connection);};com.marklogic.widgets.searchpage.reset=function(){this.bar.reset();};